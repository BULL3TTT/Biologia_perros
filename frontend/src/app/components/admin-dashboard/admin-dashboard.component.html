<div class="admin-dashboard">
  <div class="dashboard-header">
    <h1>Panel de Administrador</h1>
    <button mat-raised-button color="warn" (click)="logout()">
      <mat-icon>logout</mat-icon>
      Cerrar Sesión
    </button>
  </div>

  <div class="stats-cards" *ngIf="stats">
    <div class="stat-card">
      <mat-icon>people</mat-icon>
      <div class="stat-content">
        <h3>Total Usuarios</h3>
        <p class="stat-value">{{ stats.total_users }}</p>
      </div>
    </div>
    <div class="stat-card">
      <mat-icon>assignment</mat-icon>
      <div class="stat-content">
        <h3>Total Respuestas</h3>
        <p class="stat-value">{{ stats.total_responses }}</p>
      </div>
    </div>
    <div class="stat-card">
      <mat-icon>trending_up</mat-icon>
      <div class="stat-content">
        <h3>Promedio General</h3>
        <p class="stat-value">{{ stats.average_score }}%</p>
      </div>
    </div>
  </div>

  <div class="top-scores-section">
    <h2>Top 3 Puntuaciones</h2>
    <div class="top-scores-grid">
      <div *ngFor="let score of topScores; let i = index" class="top-score-card" [class]="'rank-' + (i + 1)">
        <div class="rank-badge">{{ i + 1 }}</div>
        <div class="score-info">
          <h3>{{ score.nombre_completo }}</h3>
          <p class="email">{{ score.correo_institucional }}</p>
          <div class="score-details">
            <span class="score-value" [style.color]="getScoreColor(score.puntuacion)">
              {{ score.puntuacion }}%
            </span>
            <span class="score-breakdown">
              {{ score.respuestas_correctas }}/{{ score.total_respuestas }} correctas
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="charts-section">
    <h2>Gráficas y Estadísticas</h2>
    <div class="charts-grid">
      <div class="chart-card">
        <canvas baseChart
          [data]="barChartData"
          [options]="barChartOptions"
          [type]="barChartType">
        </canvas>
      </div>
      <div class="chart-card">
        <canvas baseChart
          [data]="pieChartData"
          [options]="pieChartOptions"
          [type]="pieChartType">
        </canvas>
      </div>
      <div class="chart-card full-width">
        <canvas baseChart
          [data]="lineChartData"
          [options]="lineChartOptions"
          [type]="lineChartType">
        </canvas>
      </div>
    </div>
  </div>

  <div class="results-section">
    <div class="section-header">
      <h2>Resultados Completos</h2>
      <div class="header-actions">
        <button 
          mat-raised-button 
          color="primary" 
          (click)="refreshData()" 
          [disabled]="isLoading"
          class="refresh-button">
          <mat-icon>refresh</mat-icon>
          {{ isLoading ? 'Actualizando...' : 'Actualizar' }}
        </button>
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Buscar</mat-label>
          <input matInput (keyup)="applyFilter($event)" placeholder="Buscar por nombre, correo, etc.">
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>
      </div>
    </div>

    <div class="table-container">
      <table mat-table [dataSource]="dataSource" class="results-table">
        <ng-container matColumnDef="nombre_completo">
          <th mat-header-cell *matHeaderCellDef>Nombre Completo</th>
          <td mat-cell *matCellDef="let row">{{ row.nombre_completo }}</td>
        </ng-container>

        <ng-container matColumnDef="grado">
          <th mat-header-cell *matHeaderCellDef>Grado</th>
          <td mat-cell *matCellDef="let row">{{ row.grado }}°</td>
        </ng-container>

        <ng-container matColumnDef="grupo">
          <th mat-header-cell *matHeaderCellDef>Grupo</th>
          <td mat-cell *matCellDef="let row">{{ row.grupo }}</td>
        </ng-container>

        <ng-container matColumnDef="correo_institucional">
          <th mat-header-cell *matHeaderCellDef>Correo</th>
          <td mat-cell *matCellDef="let row">{{ row.correo_institucional }}</td>
        </ng-container>

        <ng-container matColumnDef="total_respuestas">
          <th mat-header-cell *matHeaderCellDef>Total Respuestas</th>
          <td mat-cell *matCellDef="let row">{{ row.total_respuestas || 0 }}</td>
        </ng-container>

        <ng-container matColumnDef="respuestas_correctas">
          <th mat-header-cell *matHeaderCellDef>Correctas</th>
          <td mat-cell *matCellDef="let row">{{ row.respuestas_correctas || 0 }}</td>
        </ng-container>

        <ng-container matColumnDef="puntuacion">
          <th mat-header-cell *matHeaderCellDef>Puntuación</th>
          <td mat-cell *matCellDef="let row">
            <span class="score-badge" [style.background-color]="getScoreColor(getNumericScore(row.puntuacion))">
              {{ formatScore(row.puntuacion) }}%
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="fecha_registro">
          <th mat-header-cell *matHeaderCellDef>Fecha</th>
          <td mat-cell *matCellDef="let row">{{ formatDate(row.fecha_registro) }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

        <mat-paginator 
          [pageSizeOptions]="[10, 25, 50, 100]" 
          [pageSize]="25"
          showFirstLastButtons>
        </mat-paginator>
    </div>
  </div>

  <mat-spinner *ngIf="isLoading" class="loading-spinner"></mat-spinner>
</div>

